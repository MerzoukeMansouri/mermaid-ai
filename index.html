<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./styles.css" rel="stylesheet">
    <title>Mermaid Live Visualizer</title>
  </head>
  <body>
    <div id="app">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <h1>Mermaid Live Visualizer</h1>
          <button id="selectDirBtn" class="btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
            Select Directory
          </button>
        </div>
        <div id="currentPath" class="current-path"></div>
      </header>

      <!-- Main Content -->
      <div class="main-container">
        <!-- Sidebar with file list -->
        <aside class="sidebar">
          <div class="search-container">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Fuzzy search files..."
              autocomplete="off"
            >
            <div class="search-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
          </div>

          <div id="fileList" class="file-list">
            <div class="empty-state">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p>No directory selected</p>
              <p class="hint">Click "Select Directory" to get started</p>
            </div>
          </div>
        </aside>

        <!-- Preview area -->
        <main class="preview-container">
          <div id="previewHeader" class="preview-header hidden">
            <span id="fileName" class="file-name"></span>
            <span class="live-badge">
              <span class="live-dot"></span>
              Live
            </span>
          </div>

          <div id="previewArea" class="preview-area">
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <p>Select a Mermaid file to preview</p>
              <p class="hint">Changes will be reflected in real-time</p>
            </div>
          </div>

          <!-- Zoom Controls -->
          <div id="zoomControls" class="zoom-controls hidden">
            <button id="zoomOutBtn" class="zoom-btn" title="Zoom Out">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
                <path d="M8 11h6"></path>
              </svg>
            </button>
            <button id="zoomResetBtn" class="zoom-btn" title="Reset Zoom">
              <span id="zoomLevel">100%</span>
            </button>
            <button id="zoomInBtn" class="zoom-btn" title="Zoom In">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
                <path d="M11 8v6"></path>
                <path d="M8 11h6"></path>
              </svg>
            </button>
            <button id="fitBtn" class="zoom-btn" title="Fit to Screen">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"></path>
              </svg>
            </button>
            <button id="fullscreenBtn" class="zoom-btn" title="Enter Focus Mode">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"></path>
                <path d="M4 4l4 4m12-4l-4 4m4 12l-4-4m-12 4l4-4"></path>
              </svg>
            </button>
          </div>

          <!-- AI Editor Panel -->
          <div id="aiPanel" class="ai-panel hidden">
            <div class="ai-panel-header">
              <h3>AI Assistant (Ollama)</h3>
              <button id="closeAiPanel" class="ai-close-btn">Ã—</button>
            </div>

            <div class="ai-status">
              <span id="ollamaStatus" class="status-indicator">
                <span class="status-dot"></span>
                <span id="statusText">Checking...</span>
              </span>
            </div>

            <div class="ai-content">
              <div class="ai-instruction-area">
                <label for="aiInstruction">Instruction for AI:</label>
                <textarea
                  id="aiInstruction"
                  class="ai-instruction-input"
                  placeholder="e.g., Add colors to all nodes, Fix syntax errors, Simplify the diagram..."
                  rows="4"
                ></textarea>

                <button id="aiEditBtn" class="ai-edit-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                  </svg>
                  Generate Edit
                </button>
              </div>

              <!-- Preview/Diff Area -->
              <div id="aiPreview" class="ai-preview hidden">
                <div class="ai-preview-header">
                  <div class="ai-view-toggle">
                    <button id="codeViewBtn" class="view-toggle-btn active">Code</button>
                    <button id="previewViewBtn" class="view-toggle-btn">Preview</button>
                  </div>
                  <div class="ai-preview-actions">
                    <button id="aiApplyBtn" class="ai-apply-btn">Apply Changes</button>
                    <button id="aiCancelBtn" class="ai-cancel-btn">Cancel</button>
                  </div>
                </div>
                <div id="aiDiffContent" class="ai-diff-content">
                  <!-- Code diff will be shown here -->
                </div>
                <div id="aiPreviewContent" class="ai-preview-content hidden">
                  <!-- Preview will be shown here -->
                </div>
              </div>

              <!-- History -->
              <div class="ai-history">
                <h4>Version History</h4>
                <div id="aiHistoryList" class="ai-history-list">
                  <!-- History items will be added here -->
                </div>
              </div>
            </div>
          </div>

          <!-- AI Toggle Button -->
          <button id="aiToggleBtn" class="ai-toggle-btn hidden" title="AI Assistant">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"></path>
              <circle cx="12" cy="12" r="5"></circle>
            </svg>
          </button>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <script src="./renderer.js"></script>
    <script src="./ai-control.js"></script>
  </body>
</html>
